#!/usr/bin/env zsh

before=$(realpath "$(which emacs)")
echo "invoking nixos-rebuild"

nix flake prefetch github:cassandracomar/nix-config
sudo /run/current-system/sw/bin/nixos-rebuild --flake github:cassandracomar/nix-config $*

if [ "$(realpath $(which emacs))" != "$before" ]; then
    echo "emacs changed. invoking native compilation rebuild."
    ~/.emacs.d/bin/doom build
fi
